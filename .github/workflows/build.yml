name: Build and Release IPA

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby (for fastlane, opzionale)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1

    - name: Install dependencies
      run: |
        # Se usi Cocoapods
        if [ -f "Podfile" ]; then
          gem install cocoapods
          pod install
        fi

    - name: Build IPA
      run: |
        xcodebuild -workspace TUOPROGETTO.xcworkspace \
          -scheme TUA_SCHEME \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $PWD/build/App.xcarchive archive

        xcodebuild -exportArchive \
          -archivePath $PWD/build/App.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath $PWD/build

    - name: Upload IPA to release
      uses: softprops/action-gh-release@v2
      with:
        files: build/*.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
